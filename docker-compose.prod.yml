# Production Docker Compose for Memory System
# Deployed on SARK/CLU Cluster for Network Access

version: '3.8'

services:
  # Memory System Core Service
  memory-system:
    image: node:18-alpine
    container_name: memory-system
    restart: unless-stopped
    ports:
      - "3000:3000"   # HTTP API for all clients
    environment:
      - NODE_ENV=production
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=3000
      - MCP_PORT=8080
      - DATA_DIR=/app/data
      - MAX_RESULTS=10
      - MIN_SIMILARITY=0.1
      - EMBEDDING_DIMENSION=768
      - CACHE_SIZE=1000
    volumes:
      - data_storage:/app/data
      - logs_storage:/app/logs
    networks:
      - memory-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ChromaDB Connection Service (External)
  chromadb-service:
    image: curlimages/curl:latest
    container_name: chromadb-health-check
    restart: unless-stopped
    command: >
      sh -c "
        echo 'ğŸ”— Connecting to external ChromaDB at 192.168.68.69:8001'
        while ! curl -f -s -u admin:admin http://192.168.68.69:8001/api/v1/heartbeat; do
          echo 'â³ Waiting for ChromaDB...'
          sleep 5
        done
        echo 'âœ… ChromaDB connection established'
      "
    networks:
      - memory-network

  # OpenAI-Compatible API Gateway
  api-gateway:
    image: nginx:alpine
    container_name: memory-api-gateway
    restart: unless-stopped
    ports:
      - "80:80"        # Public HTTP API
      - "443:443"      # HTTPS (ready for SSL)
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - memory-system
    networks:
      - memory-network

  # Health Monitor
  health-monitor:
    image: alpine:latest
    container_name: memory-health-monitor
    restart: unless-stopped
    command: >
      sh -c "
        while true; do
          echo 'ğŸ¥ Health Check - $(date)'
          if curl -f http://memory-system:3000/health; then
            echo 'âœ… Memory System: HEALTHY'
          else
            echo 'âŒ Memory System: UNHEALTHY'
          fi
          echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'
          sleep 60
        done
      "
    depends_on:
      - memory-system
    networks:
      - memory-network

volumes:
  data_storage:
    driver: local
  logs_storage:
    driver: local

networks:
  memory-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16